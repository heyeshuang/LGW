<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<title>index</title>
		<meta name="description" content="" />
		<meta name="author" content="heysh" />

		<meta name="viewport" content="width=device-width; initial-scale=1.0" />

		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		<script type="text/javascript" src="http://lib.sinaapp.com/js/jquery/1.6/jquery.min.js"></script>
	</head>

	<body>
		<div>
			<header>
				<h1>index</h1>
			</header>
			<canvas id="gears" width="1200" height="800">
				<!--nothing there-->
			</canvas>
			<nav>
				<p>
					<a href="/">Home</a>
				</p>
				<p>
					<a href="/contact">Contact</a>
				</p>
			</nav>

			<div>

			</div>

			<footer>
				<p>
					&copy; Copyright  by heysh
				</p>
			</footer>
		</div>
		<script type="text/javascript">
			var canvas=$("#gears")
			var context=canvas.get(0).getContext("2d")
			//context.fillRect(0,0,canvas.width(),canvas.height())
			var pi=Math.PI;

			/*init a gear
			 * in 2 ways
			 * 
			 */
			var Gear = function (z,m,x,y){
				this.z=z;
				this.m=m;
				this.d=m*z;
				this.h=m;
				this.c=0.25*m;
				this.x=x;
				this.y=y;
			}
			function writePosition(fGear,angle){
				var l=(this.d+fGear.d)/2;
				this.x=fGear.x+l*Math.cos(angle);
				this.y=fGear.y+l*Math.sin(angle);
			}
			Gear.prototype.writePosition=writePosition;
			function genGearP(z,m,fGear,angle){			//create a new gear by angle and gears created before
				
				var tmpGear=new Gear(z,m,0,0);
				tmpGear.writePosition(fGear,angle);
				return tmpGear;
			}
			var gear1=new Gear(40,10,300,300);
			var gear2=genGearP(30,10,gear1,pi/6);
			var gear3=genGearP(100,10,gear2,-pi/2);

			function getAngle(firstGear,secondGear,angle1){
				var x1=firstGear.x;
				var x2=secondGear.x;
				var y1=firstGear.y;
				var y2=secondGear.y;
				var z1=firstGear.z;
				var z2=secondGear.z;
				var a=Math.atan2(y1-y2,x2-x1);
				return (-a+Math.PI*(1-1/z2)-angle1*z1/z2-a*z1/z2);
				
			}
			
			function preCanvasG(anyGear){
				var gcanvas=document.createElement('canvas');
				gcanvas.width=anyGear.d+2*anyGear.h;
				gcanvas.height=anyGear.d+2*anyGear.h;
				var gcontext=gcanvas.getContext('2d');
				gcontext.beginPath();
				for (var i=0; i < anyGear.z; i++) {
					var pi=Math.PI;
					var z=anyGear.z;
					gcontext.arc(anyGear.d/2+anyGear.h,anyGear.d/2+anyGear.h,anyGear.d/2+anyGear.h,i*2*pi/z,(i+1/4)*2*pi/z,false);
					gcontext.arc(anyGear.d/2+anyGear.h,anyGear.d/2+anyGear.h,anyGear.d/2-anyGear.h-anyGear.c,(i+1/2)*2*pi/z,(i+3/4)*2*pi/z,false);
				};
				gcontext.closePath();
				gcontext.stroke();
				gcontext.fillStyle="rgb(255,255,255)";
				gcontext.globalCompositeOperation="destination-over";
				gcontext.globalAlpha="0.7";
				gcontext.fill();
				return gcanvas;
			}
			
			function drawAGear2(canvasG,thisGear,angle){
				var angle=angle-2*Math.PI/thisGear.z*5/8;
				context.save();
				context.translate(thisGear.x,thisGear.y);
				context.rotate(angle);
				context.drawImage(canvasG,-(thisGear.d/2+thisGear.h),-(thisGear.d/2+thisGear.h));
				context.restore();
			}
					
			function eraseAGear(){}

			function drawAll(){
				if (rotateTime>=360){
					rotateTime=rotateTime-360;
				}
				context.clearRect(0,0,canvas.width(),canvas.height());
				var rAngle=rotateTime/180*Math.PI;
				drawAGear2(canvas1,gear1,rAngle);
				var angle2=getAngle(gear1,gear2,rAngle);
				drawAGear2(canvas2,gear2,angle2);
				var angle3=getAngle(gear2,gear3,angle2);
				drawAGear2(canvas3,gear3,angle3);
				rotateTime=rotateTime+0.2;
				requestAnimFrame(function() {drawAll();});
			}
			
		window.requestAnimFrame = (function(callback){
    		return window.requestAnimationFrame ||
   				window.webkitRequestAnimationFrame ||
   				window.mozRequestAnimationFrame ||
    			window.oRequestAnimationFrame ||
    			window.msRequestAnimationFrame ||
    			function(callback){
        			window.setTimeout(callback, 1000 / 60);
    			};
		})();
			var rotateTime=1;
			canvas1=preCanvasG(gear1);
			canvas2=preCanvasG(gear2);
			canvas3=preCanvasG(gear3);
			window.onload = function(){
    			drawAll();
			};

		</script>
	</body>
</html>
